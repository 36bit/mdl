<PACKAGE "M-MSG">

<ENTRY SENDMSG RQOPEN RQCLOSE>

<USE "M-DEFS" "M-DATA" "ITIME" "OPSYS">

<DEFINE SENDMSG (TO SUB "OPTIONAL" TXT (FRM <SNAME>)
		 "TUPLE" FF "AUX" CC) 
	#DECL ((CC) CHANNEL (TO) LIST (TXT) STRING (FRM SUB) STRING
	       (FF) TUPLE)
	<COND (<NOT <ASSIGNED? TXT>> <SET TXT .SUB> <SET SUB "">)>
	<SET CC <RQOPEN>>
	<PRINT "WHEN-ORIGINATED" .CC>
	<PRINT <ITIME> .CC>
	<PRINT "TO" .CC>
	<PRINT .TO .CC>
	<COND (<NOT <EMPTY? .SUB>>
	       <PRINT "SUBJECT" .CC>
	       <PRINT .SUB .CC>)>
	<PRINT "TEXT" .CC>
	<PRINT .TXT .CC>
	<PRINT "FROM" .CC>
	<PRINT .FRM .CC>
	<MAPF <> <FUNCTION (F) <PRINT .F .CC>> .FF>
	<PRINT "SCHEDULE" .CC>
	<PRINT '("SENDING") .CC>
	<RQCLOSE .CC>
	T>

\

"RQOPEN -- open a new request file for writing, return channel"

<DEFINE RQOPEN ("AUX" (SNM <DATUM "COMSYS-MESSAGE-DIR">) C) 
	#DECL ((SNM) <SPECIAL STRING> (VALUE) CHANNEL (C) <OR FALSE CHANNEL>)
	<COND (<SET C <OPEN "PRINT" "_RQST_">>)
	      (ELSE <ERROR CANNOT-OPEN-REQUEST-FILE RQOPEN .C>)>>

"RQCLOSE -- rename file on channel to a given name and close it"

<DEFINE RQCLOSE (CH "AUX" R (FN <DATUM "COMSYS-NEW-FILE">))
	#DECL ((CH) CHANNEL (R) ANY (FN) STRING)
	<COND (<SET R 
		    <OPSYS (TOPS-20
			    <CLOSE .CH>
			    <RENAME <FILCHN .CH> TO .FN>)
			   (ITS
			    <RENAME .CH .FN>)>>
	       <CLOSE .CH>)
	      (ELSE <ERROR CANNOT-RENAME-REQUEST-FILE RQCLOSE .CH .R>)>>

<ENDPACKAGE>
