
<DEFINE SUBSTR (FROM-STRUCTURE "OPT" (DELETE 0) 
				     (LNGTH  <- <LENGTH .FROM-STRUCTURE>
						.DELETE>) TO-STRUCTURE
			       "AUX" (I O)) 
   #DECL ((I DELETE LNGTH) FIX (TO-STRUCTURE FROM-STRUCTURE) STRUCTURED)
   <COND
    (<AND <ASSIGNED? TO-STRUCTURE>
	  <OR <AND <TYPE? .FROM-STRUCTURE TUPLE>
		   <N==? <PRIMTYPE .TO-STRUCTURE> VECTOR>>
	      <AND <TYPE? .TO-STRUCTURE TUPLE>
		   <NOT <TYPE? .FROM-STRUCTURE VECTOR>>>
	      <AND <NOT <TYPE? .FROM-STRUCTURE TUPLE>>
		   <NOT <TYPE? .TO-STRUCTURE TUPLE>>
		   <N==? <TYPE .TO-STRUCTURE>
			 <PRIMTYPE .FROM-STRUCTURE>>>>>
     <ERROR "BAD-ARGUMENT-TYPE-TO-SUBSTR">)
    (<AND <ASSIGNED? TO-STRUCTURE>
	  <==? <PRIMTYPE .TO-STRUCTURE> UVECTOR>
	  <==? <PRIMTYPE .FROM-STRUCTURE> UVECTOR>
	  <N==? <UTYPE .FROM-STRUCTURE> <UTYPE .TO-STRUCTURE>>>
     <ERROR "UVECTORS-WITH-DIFFERENT-UTYPES--SUBSTR">)
    (<OR <G? .LNGTH <LENGTH .FROM-STRUCTURE>>
	 <AND <ASSIGNED? TO-STRUCTURE> <G? .LNGTH <LENGTH .TO-STRUCTURE>>>
	 <L? .LNGTH 0>
	 <L? .DELETE 0>>
     <ERROR "OUT-OF-BOUNDS--SUBSTRUC">)
    (<NOT <ASSIGNED? TO-STRUCTURE>>
     <MAPF <COND (<TYPE? .FROM-STRUCTURE TUPLE> ,VECTOR)
		 (<TYPE? .FROM-STRUCTURE BYTES>
		  #FUNCTION (("TUPLE" BYTE-NUMS) 
			     <BYTES <BYTE-SIZE .FROM-STRUCTURE> !.BYTE-NUMS>))
		 (ELSE ,<PRIMTYPE .FROM-STRUCTURE>)>
	   #FUNCTION ((X) 
		      <COND (<==? .LNGTH .I> <MAPSTOP>)
			    (ELSE
			     <SET I <+ .I 1>>)> .X)
	   <REST .FROM-STRUCTURE .DELETE>>)
    (ELSE
     <REPEAT ((TS .TO-STRUCTURE))
	     <COND (<0? .LNGTH> <RETURN .TO-STRUCTURE>)>
	     <PUT .TS 1 <1 .FROM-STRUCTURE>>
	     <SET TS <REST .TS>>
	     <SET FROM-STRUCTURE <REST .FROM-STRUCTURE>>
	     <SET LNGTH <- .LNGTH 1>>>)>>

<DEFINE CHTYPE-IF-NECESSARY (STRUCT TYP) 
	<COND (<=? .TYP <TYPEPRIM .TYP>> .STRUCT)
	      (ELSE <CHTYPE .STRUCT .TYP>)>>
