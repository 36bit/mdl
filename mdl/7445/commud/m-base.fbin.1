'<PCODE "1M-BAS">

<PACKAGE "M-BASE"> 

"basic net-mail sending functions" 

<ENTRY UPDATE-DEAD-HOSTS MAIL-TEMP-FILE FLUSH-NET-MESSAGE NET-MESSAGE 
MAIL-RESULT NEXT-DELIVERY-ATTEMPT ESCAPING-ITS-HEADER? QPEEK XRCP-LIST ERRHND 
EHAN TIMED-OUT IOCHND IHAN IGNORE ICP-TRIES> 

<USE "MADMAN" "CHAN" "FIELDS" "CLOCK" "M-DEFS" "M-TIME" "ITIME" "M-PRCD" 
"M-READ" "M-DAC" "M-DOUT" "NETFTP" "HOSTS" "M-DATA" "M-TEMP" "M-ACK" "PRTUTI" 
"PRTSTR" "AP" "M-ERR" "USRUTI" "M-TAI"> 

<GDECL (IHAN EHAN) HANDLER (DF) FLOAT (NET-INC ICP-TRIES) FIX (NET-RETRY-CODES) 
<UVECTOR FIX>> 

<SETG ICP-TRIES 2> 

<SETG NET-RETRY-CODES '![7 10 11 13 14 17 18 20 21 22!]> 

<SETG NET-INC </ 262144 24>> 

\ 

<SETG MAIL-TEMP-FILE  %<RSUBR!- '[ %<PCODE!- "1M-BAS" 0> MAIL-TEMP-FILE #DECL (
"VALUE" <OR CHANNEL FALSE STRING> ADDRESS) FRATM FRAMES UPDMSG MSGPNQ MREAD 
MAKE-DATUM ICP PRCADD QTIME BEDRIDDEN? DWT DAPPMSG COND-SIGNAL ITIME SCROUT 
FILCHN DO-OUTPUT DO-APPLY DATUM AFALSE AP? HOST HOME? DRD DRDMSG SPLITS? %<RGLOC
MSG-SPACE T> %<TYPE-W SPACE VECTOR> "QSEND" %<RGLOC NET-MESSAGE T> "DDT-FORMAT" 
"RECEIVED-FROM-HOST" "FORWARDING" "NET-FORWARDING-FORMAT" "NET-DELIVERY-FORMAT" 
"NETWORK-MAIL" %<INTERNAL-RSUBR ASTRING 262143> "PRINTB" "COMSYS-NET-TEMP" 
"Net message flushed" %<RGLOC PENDING-QUEUE T> %<RGLOC MDB T> "ITS-HEADER" 
"ITS-SITES" T "DELIVERY" %<INTERNAL-RSUBR ALIST 262143> %<INTERNAL-RSUBR ACOPY 2
> "Placing message in hold until host reappears." "Delivery Failure, Code: " %<
RGLOC NET-RETRY-CODES T> 
"Sick of trying this loser, it's been 30 days.  I give up." %<RGLOC NET-INC T> 
"Host will someday be up, will try in " " days." "Delivery failed, will try in "
 " minutes." "DEAD-HOSTS" %<RGLOC LAST-CHECK T> "Confirming death of " 
"!!! It's alive! !!!" ">>> Still dead. <<<" "PROCESSING-NEEDED" 
"NET-DELIVERY-ERRORS" ": Rescheduling DELIVERY to " " at " "." NETOUT 
">>>> Ioc During Net Delivery: " " <<<<" ">>>> Channel in Error: " "<<<<" 
">>>> Transaction timed out: 15 minutes! <<<<" BAD-CHANNEL!-ERRORS 
"Channel closed during Net delivery" 
">>>> Error Inside Net Delivery Area, Args -- " LERR\ !-INTERRUPTS OUTCHAN]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,MAIL-TEMP-FILE PGLUE ![715827882 -22906503168 
0 0 0 0!]>> 


\ 

"FLUSH-NET-MESSAGE -- get rid of NETMSG file" 

<SETG FLUSH-NET-MESSAGE %<RSUBR-ENTRY '[MAIL-TEMP-FILE FLUSH-NET-MESSAGE #DECL (
"VALUE" <OR CHANNEL FALSE>)] 195>> 

<SETG NET-MESSAGE <>> 

<GDECL (NET-MESSAGE) <OR FALSE CHANNEL>> 

\ 

"QPEEK -- obscenity to see if the current run of a process is the last one
currently scheduled for that process.  Used for XRCP disgust to determine
when to actually send the message." 

<SETG QPEEK %<RSUBR-ENTRY '[MAIL-TEMP-FILE QPEEK #DECL ("VALUE" <OR ATOM FALSE> 
STRING STRING)] 228>> 

"xrcp goodies" 

<SETG XRCP-LIST ()> 

<GDECL (XRCP-LIST) <LIST [REST ADDRESS]>> 

\ 

<SETG ESCAPING-ITS-HEADER? %<RSUBR-ENTRY '[MAIL-TEMP-FILE ESCAPING-ITS-HEADER? #
DECL ("VALUE" <OR ATOM FALSE> FIX)] 392>> 

\ 

"MAIL-RESULT -- update status of message based on result of this attempt" 

<SETG MAIL-RESULT %<RSUBR-ENTRY '[MAIL-TEMP-FILE MAIL-RESULT #DECL ("VALUE" <OR 
ATOM FALSE> ADDRESS ANY "OPTIONAL" ANY)] 430>> 

\ 

"NEXT-DELIVERY-ATTEMPT -- schedule next delivery attempt or return false" 

<SETG NEXT-DELIVERY-ATTEMPT %<RSUBR-ENTRY '[MAIL-TEMP-FILE NEXT-DELIVERY-ATTEMPT
#DECL ("VALUE" <OR ATOM FALSE> ADDRESS)] 596>> 

\ 

"UPDATE-DEAD-HOSTS -- hack for handling dead hosts and checking to
see if they have come alive." 

<SETG LAST-CHECK 0> 

<GDECL (LAST-CHECK) FIX> 

<SETG UPDATE-DEAD-HOSTS %<RSUBR-ENTRY '[MAIL-TEMP-FILE UPDATE-DEAD-HOSTS #DECL (
"VALUE" <OR ATOM FALSE> <OR FALSE VECTOR>)] 746>> 

\ 

<SETG IGNORE %<RSUBR-ENTRY '[MAIL-TEMP-FILE IGNORE #DECL ("VALUE" <OR FALSE 
HANDLER IHEADER> ATOM)] 1036>> 

"interrupt handlers for network delivery" 

<SETG IOCHND %<RSUBR-ENTRY '[MAIL-TEMP-FILE IOCHND #DECL ("VALUE" ANY FALSE 
CHANNEL)] 1066>> 

<SETG TIMED-OUT %<RSUBR-ENTRY '[MAIL-TEMP-FILE TIMED-OUT #DECL ("VALUE" ANY ANY)
] 1134>> 

<SETG ERRHND %<RSUBR-ENTRY '[MAIL-TEMP-FILE ERRHND #DECL ("VALUE" ANY "TUPLE" 
TUPLE)] 1171>> 

<ENDPACKAGE> 
