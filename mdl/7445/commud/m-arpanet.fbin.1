'<PCODE "1M-ARP">

<PACKAGE "M-ARPANET"> 

<ENTRY ARPANET-DELIVERY MAIL-FILE TRY-XRCP? ARPANET-QUIT USER-LOSERS> 

<USE "MADMAN" "CHAN" "FIELDS" "CLOCK" "M-DEFS" "M-TIME" "M-BASE" "ITIME" 
"M-PRCD" "M-READ" "M-DAC" "M-DOUT" "NETFTP" "HOSTS" "M-DATA" "M-TEMP" "M-ACK" 
"PRTUTI" "PRTSTR" "AP" "M-ERR" "USRUTI" "M-TAI"> 

\ 

<GDECL (NET-MESSAGE) <OR FALSE CHANNEL> (FTP-CONNECTION) <OR FALSE <LIST [2 
CHANNEL]>> (IHAN EHAN) HANDLER (CR EOM) STRING (ICP-TRIES) FIX (DF) FLOAT (
NET-RETRY-CODES USER-LOSERS) <UVECTOR FIX> (TRY-XRCP?) <OR ATOM FALSE>> 

<SETG TRY-XRCP? T> 

<SETG FTP-CONNECTION <>> 

<SETG CR <STRING <ASCII 13> <ASCII 10>>> 

<SETG NET-RETRY-CODES '![7 10 11 13 14 17 18 20 21 22!]> 

<SETG USER-LOSERS '![450 451!]> 

<SETG EOM <STRING <ASCII 13> <ASCII 10> "." <ASCII 13> <ASCII 10>>> 

\ 

"ARPANET-DELIVERY -- network output for message.  Note that this reads
  'net-delivery-format' from the author rather than receiver area; this
  is to allow chomps like inquire updating to work, besides, what net
  receiver would have a tailor, anyway?" 

<SETG ARPANET-DELIVERY  %<RSUBR!- '[ %<PCODE!- "1M-ARP" 0> ARPANET-DELIVERY #
DECL ("VALUE" ANY ADDRESS STRING FIX) FLUSH-NET-MESSAGE ALARM-OFF IGNORE 
MAIL-RESULT PR WAITRESP AFALSE QPEEK HOST ALARM WATCH SPLITS? DRDMSG SCROUT ICP 
MAIL-TEMP-FILE %<RGLOC ICP-TRIES T> "DEVICE NOT READY" "ARPAnet apparently down"
 "Retrying ICP" %<TYPE-W CINT VECTOR> "QSEND" %<RGLOC MSG-SPACE T> %<TYPE-W 
SPACE VECTOR> "READ" %<RGLOC NET-MESSAGE T> NETOUT (ACTIVATION) EHAN "ERROR" %<
RGLOC ERRHND T> IHAN "IOC" %<RGLOC IOCHND T> %<RGLOC TIMED-OUT T> "DELIVERY" T 
"ICP Successful" (300) %<RGLOC FTP-CONNECTION T> %<RGLOC XRCP-R? T> %<RGLOC 
XRCP-T? T> %<RGLOC XRCP-T-MAIL? T> %<RGLOC XRCP-LIST T> %<RGLOC TRY-XRCP? T> 
"XRSQ R" (200) "XRSQ T" "MAIL" "XRCP " (200 440) %<INTERNAL-RSUBR ACOPY 2> 
"XSEN " "XSEM " "XMAS " (256) "MAIL " %<INTERNAL-RSUBR ASTRING 262143> 
"FTP connection to " " exists" "FTP closed" WAIT-ACT %<RGLOC EOM T> (350 504) 
"USER NETML" (330) "PASS NETML" (230) (350) %<RGLOC USER-LOSERS T> %<RGLOC 
LAST-RESP T> %<RGLOC SOAK? T> OUTCHAN "     "]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,ARPANET-DELIVERY PGLUE ![715827882 
*400000000000* 0 0 0!]>> 


\ 

"FTP-OPEN -- open an FTP connection" 

<SETG FTP-OPEN %<RSUBR-ENTRY '[ARPANET-DELIVERY FTP-OPEN #DECL ("VALUE" <OR 
FALSE <LIST [2 CHANNEL]>> FIX)] 26>> 

\ 

"MAIL-FILE -- given addressee and file containing mail, send it" 

<SETG MAIL-FILE %<RSUBR-ENTRY '[ARPANET-DELIVERY MAIL-FILE #DECL ("VALUE" <OR 
ATOM FALSE> ADDRESS STRING FIX <OR STRING CHANNEL>)] 80>> 

\ 

"CONNECTED?" 

<SETG CONNECTED? %<RSUBR-ENTRY '[ARPANET-DELIVERY CONNECTED? #DECL ("VALUE" <OR 
FALSE <LIST CHANNEL CHANNEL>> <OR FIX FALSE VECTOR>)] 674>> 

"xrcp goodies" 

<SETG XRCP-R? <>> 

<SETG XRCP-T? <>> 

<SETG XRCP-T-MAIL? <>> 

<GDECL (XRCP-R? XRCP-T? XRCP-T-MAIL?) <OR ATOM FALSE>> 

\ 

"ARPANET-QUIT -- flush ftp connection" 

<SETG ARPANET-QUIT %<RSUBR-ENTRY '[ARPANET-DELIVERY ARPANET-QUIT #DECL ("VALUE" 
<OR FALSE <LIST [2 CHANNEL]>>)] 728>> 

\ 

"SEND-MAIL -- copy mail file open on first arg to ftp." 

<SETG SEND-MAIL %<RSUBR-ENTRY '[ARPANET-DELIVERY SEND-MAIL #DECL ("VALUE" ANY 
CHANNEL CHANNEL CHANNEL)] 778>> 

"MCMD -- do a standard mail command (used for MAIL and XSEN)" 

<SETG MCMD %<RSUBR-ENTRY '[ARPANET-DELIVERY MCMD #DECL ("VALUE" ANY CHANNEL 
CHANNEL STRING "OPTIONAL" STRING)] 845>> 

"FTP-REPLY -- analyzes an FTP reply and returns an appropriate false
if it is not a winner." 

<SETG FTP-REPLY %<RSUBR-ENTRY '[ARPANET-DELIVERY FTP-REPLY #DECL ("VALUE" ANY 
ANY FIX FIX FIX)] 960>> 

"PR -- print message to net channel and script" 

<SETG PR %<RSUBR-ENTRY '[ARPANET-DELIVERY PR #DECL ("VALUE" ATOM CHANNEL "TUPLE"
<TUPLE [REST STRING]>)] 1063>> 

<ENDPACKAGE> 
