'<PCODE "1M-MM">

<PACKAGE "M-MM"> 

<ENTRY READMAIL> 

<USE "R-DEFS" "M-PRS" "M-READ" "M-TIME" "PRTUTI" "ITIME" "M-DEFS" "ASYLUM" 
"MADMAN"> 

<SETG HSTR <ISTRING 22>> 

<GDECL (HSTR) STRING> 

<SETG SELECTION -1> 

<GDECL (SELECTION) FIX> 

<SETG READMAIL  %<RSUBR!- '[ %<PCODE!- "1M-MM" 0> READMAIL #DECL ("VALUE" <OR 
ATOM FALSE> ANY "OPTIONAL" FIX STRING) AIUVECTOR DATA-APRINT DATA-RESERVE 
DATA-CLOSE DATA-OPEN AFALSE DRDMSG DATA-PRINTW DATA-READW STORE-PARSE ITIME 
MPDATE ADDFLD MAIL-PARSE AISTRING AVECTOR ARESET DDT-ADRL DDT-ADR DRD SCROUT %<
RGLOC SELECTION T> "MAIL.TXT" "<" ">" "READ" ">READER.ASYLUM" %<INTERNAL-RSUBR 
OPEN-DATA-FILE 1> %<RGLOC SCRATCH-SPACE T> %<TYPE-W SPACE VECTOR> 
"Copying MM file: " " to Asylum " %<INTERNAL-RSUBR ARESET 1> %<INTERNAL-RSUBR 
DATA-AREAD 3> ": " "SENDER" "FROM" OUTCHAN " => " "ACTION-TO" "  Delivered as " 
"  ***Failed: " "Skipping message: Selection test failed." "***Parse failed: " 
%<INTERNAL-RSUBR AVECTOR 262143> %<INTERNAL-RSUBR DATA-APRINT 4> 
"Reader Asylum local table written." M-ASYLUM %<INTERNAL-RSUBR ACOPY 2> 
"Reader Asylum new messages list written." M-NEW %<INTERNAL-RSUBR 
CLOSE-DATA-FILE 1> "Copy completed." %<RGLOC HSTR T> %<RGLOC MDB T> %<RGLOC 
MSG-SPACE T> "," #FALSE ("Eof") T #FALSE ("Bad receive date") #FALSE (
"Bad Message Length") #FALSE ("Bad Message Bits") #FALSE ("Message Length Lied")
 "MSG-NO" "WHEN-RECEIVED" "BITS" CANT-ALLOCATE-NEW-ID!-ERRORS "PRINT" 
%<INTERNAL-RSUBR DATA-OPEN 3> %<INTERNAL-RSUBR DATA-CLOSE 2> "ABOUT-TO-CLOBBER" 
%<INTERNAL-RSUBR ASTRING 262143> %<INTERNAL-RSUBR DATA-IPRINT 4> %<TYPE-W ASYLUM
VECTOR> BAD-ASYLUM!-ERRORS "Initializing New Reader Asylum" 
MESSAGE-TABLE?!-ERRORS]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,READMAIL PGLUE ![715827882 -22917677056 0 0 0 
0!]>> 


<SETG READMESSAGE %<RSUBR-ENTRY '[READMAIL READMESSAGE #DECL ("VALUE" <OR ATOM 
CHANNEL FALSE UVECTOR> CHANNEL "OPTIONAL" FIX <OR FALSE ASYLUM>)] 404>> 

<SETG ATTACH %<RSUBR-ENTRY '[READMAIL ATTACH #DECL ("VALUE" LIST LIST LIST)] 672
>> 

"GENERATE-ID -- function for allocating unique message ids." 

<SETG GENERATE-ID %<RSUBR-ENTRY '[READMAIL GENERATE-ID #DECL ("VALUE" FIX ANY)] 
703>> 

<SETG READWORD %<RSUBR-ENTRY '[READMAIL READWORD #DECL ("VALUE" <OR FALSE FIX> 
CHANNEL)] 752>> 

<SETG READNUM %<RSUBR-ENTRY '[READMAIL READNUM #DECL ("VALUE" <OR FALSE FIX> 
CHANNEL)] 818>> 

\ 

"MAIL-DELIVERY -- deliver citation and message to user's asylum
	takes: asylum to deliver to
	       vector of locally-stored messages from that asylum
	returns: uvector of id and local maniac stored under (or false)" 

<SETG MAIL-DELIVERY %<RSUBR-ENTRY '[READMAIL MAIL-DELIVERY #DECL ("VALUE" <OR 
FALSE LIST> <OR FALSE ASYLUM>)] 884>> 

<SETG FIND-LOCAL %<RSUBR-ENTRY '[READMAIL FIND-LOCAL #DECL ("VALUE" <OR FALSE 
FIX> FIX <VECTOR [REST FIX]>)] 1012>> 

\ 

"MAIL.TXT FLAGS:" 

<MSETG M-SEEN <BIT 35>> 

<MSETG M-DELE <BIT 34>> 

<MSETG M-ATTN <BIT 33>> 

<MSETG M-RPLY <BIT 32>> 

<MSETG M-RSRV <BIT 31>> 

<MSETG M-RSR1 <BIT 30>> 

<MSETG M-KEYW -64> 

"MM FLAGS:" 

<MSETG M-RECE <BIT 0>> 

<MSETG M-FRME <BIT 1>> 

<MSETG M-FRNM <BIT 2>> 

<SETG BIT? #MACRO ( %<RSUBR!- '[ %<PCODE!- "1M-MM" 1283> BIT? #DECL ("VALUE" 
FORM "QUOTE" ANY "QUOTE" ANY) NOT 0? CHTYPE ANDB FIX]>)> 

<SETG READER-BITS %<RSUBR-ENTRY '[READMAIL READER-BITS #DECL ("VALUE" FIX <
PRIMTYPE WORD>)] 1045>> 

<SETG SETUP-ASYLUM %<RSUBR-ENTRY '[READMAIL SETUP-ASYLUM #DECL ("VALUE" ANY 
ASYLUM SPACE)] 1102>> 

<ENDPACKAGE> 
