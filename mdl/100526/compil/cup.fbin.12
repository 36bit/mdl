'<PCODE "1CUP">

<FLOAD "PUREQ" "NBIN"> 

"AN SCL IS A TEMPORARY.  IT IS REPLACED BY A FIX WHICH IS A OFFSET OFF THE BASE OF THE
 TEMPORARIES IN THE CODE UPDATE PASS" 

<NEWTYPE SCL WORD> 

"A PFRAME IS A PSEUDO-FRAME GENERATED BY A PROG/REPEAT/MAPF/MAPR/FUNCTION.  IT CONTAINS
 INFORMATION FOR CUP'S USE." 

<NEWTYPE PFRAME VECTOR '<<PRIMTYPE VECTOR> ATOM <OR ATOM FALSE> <OR ATOM FALSE> 
LIST LIST FIX LIST>> 

<MANIFEST NAME-PF ACT-PF PRE-PF TEMPS-PF KIDS-PF NTEMPS-PF TMP-STR-PF> 

<SETG NAME-PF 1> 

<SETG ACT-PF 2> 

<SETG PRE-PF 3> 

<SETG TEMPS-PF 4> 

<SETG KIDS-PF 5> 

<SETG NTEMPS-PF 6> 

<SETG TMP-STR-PF 7> 

"A TEMPB DESCRIBES A TEMPORARY" 

<NEWTYPE TEMPB VECTOR '<<PRIMTYPE VECTOR> SCL LIST FIX FIX FIX <OR ATOM FALSE> 
LIST>> 

<MANIFEST ID-TMP REF-TMP LOC-TMP HI-TMP LO-TMP TYP-TMP STORE-TEMP> 

<SETG ID-TMP 1> 

<SETG REF-TMP 2> 

<SETG LOC-TMP 5> 

<SETG HI-TMP 3> 

<SETG LO-TMP 4> 

<SETG TYP-TMP 6> 

<SETG STORE-TEMP 7> 

"A TOKEN GIVES INFORMATION TO CUP" 

<NEWTYPE TOKEN VECTOR '<<PRIMTYPE VECTOR> FIX>> 

<MANIFEST BEGIN:FRAME END:FRAME CREATE:TEMP EMIT:PRE STORE:TMP STORE:VAR 
STORE:TVAR KILL:STORE> 

<SETG BEGIN:FRAME 1> 

<SETG END:FRAME 2> 

<SETG CREATE:TEMP 3> 

<SETG EMIT:PRE 5> 

<SETG STORE:VAR 4> 

<SETG STORE:TVAR 8> 

<SETG KILL:STORE 7> 

<SETG STORE:TMP 6> 

"BEGIN-FRAME STARTS A FRAME.  IT TAKES 3 ARGUMENTS:
	1) ATOM LATER SETG'd TO LENGTH OF TEMPORARY BLOCK
	2) FLAG INDICATING WHETHER THE FRAME IS ACTIVATED
	3) FLAG INDICATING WHETHER PRE-ALLOCATION IS TO BEGIN" 

<SETG BEGIN-FRAME  %<RSUBR!- '[ %<PCODE!- "1CUP" 0> BEGIN-FRAME #DECL ("VALUE" 
ANY ANY ANY ANY) PUREQ ADDR:TYPE1 PRE-ALLOC-VAR MESSAGE ADDON EMIT %<TYPE-W 
TOKEN VECTOR> IDT %<TYPE-W SCL WORD> T CPTR (LIST) MODEL REMOVES SNO (FIX) %<
TYPE-C TOKEN VECTOR> INCONSISTENCY "BAD TOKEN TO CUP" %<TYPE-W PFRAME VECTOR> %<
TYPE-W TEMPB VECTOR> "LOST TEMPORARY" "LOST VARIABLE" "VARIABLE NOT FOUND" 
"UNBALENCED STACK MODEL" STORE-MTEMP <NULL-MACRO> %<TYPE-C SCL WORD> PS 
PSEUDO!-OP SETG %<RGLOC TMPLST T> "BAD STORE" %<RGLOC TOKEN-MAX T> "#TOKEN <" 
SCL %<RGLOC SCL-PRINT T> TOKEN %<RGLOC TOKEN-PRINT T> %<RGLOC TOKENS T> ITEMS %<
RGLOC TOKEN-TABLE T> OUTCHAN "TEMPORARY:" "<" %<TYPE-W OPCODE!-OP WORD> 
TYPE-WORD!-OP <`PUSH  `TP*  [0]> %<TYPE-W MUDREF!-OP WORD> OBLIST OP TITLE - 
GVAL]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,BEGIN-FRAME PGLUE ![715915263 -1 -1 
-1073741824!]>> 


"END-FRAME ENDS A FRAME." 

<SETG END-FRAME %<RSUBR-ENTRY '[BEGIN-FRAME END-FRAME #DECL ("VALUE" ANY)] 28>> 

"CREATE-TMP CREATES A TEMPORARY AND RETURNS THE ID OF IT" 

<SETG CREATE-TMP %<RSUBR-ENTRY '[BEGIN-FRAME CREATE-TMP #DECL ("VALUE" SCL ANY)]
42>> 

<SETG EMIT-PRE %<RSUBR-ENTRY '[BEGIN-FRAME EMIT-PRE #DECL ("VALUE" ANY ANY)] 78>
> 

<SETG STORE-TMP %<RSUBR-ENTRY '[BEGIN-FRAME STORE-TMP #DECL ("VALUE" ANY ANY ANY
ANY)] 98>> 

\ 

<SETG CDUP %<RSUBR-ENTRY '[BEGIN-FRAME CDUP #DECL ("VALUE" <PRIMTYPE LIST> LIST)
] 128>> 

"PASS:1 SETS UP THE INITIAL MODEL FOR CUP.  IT ALSO DETERMINES WHICH VARIABLES ARE TO BE
 KEPT BY USING A MARK-BIT IN THE TEMPORARY DESCRIPTORS." 

<SETG PASS:1 %<RSUBR-ENTRY '[BEGIN-FRAME PASS:1 #DECL ("VALUE" PFRAME ANY ANY 
ANY)] 192>> 

<SETG FIXUP-VARLST %<RSUBR-ENTRY '[BEGIN-FRAME FIXUP-VARLST #DECL ("VALUE" ATOM 
LIST)] 720>> 

<SETG NULLIFY %<RSUBR-ENTRY '[BEGIN-FRAME NULLIFY #DECL ("VALUE" ANY <OR FALSE 
LIST> ANY)] 818>> 

<SETG FX %<RSUBR-ENTRY '[BEGIN-FRAME FX #DECL ("VALUE" ANY ANY)] 876>> 

"FIND-TMP LOOKS FOR A TEMPORARY.  IF IT DOESN'T FIND IT AND ERR IS T IT CAUSES AN ERROR" 

<SETG FIND-TMP %<RSUBR-ENTRY '[BEGIN-FRAME FIND-TMP #DECL ("VALUE" ANY SCL 
PFRAME)] 950>> 

\ 

"THIS IS PASS2 OF THE VARIABLE ALLOCATION PROCESS.  DURING THIS PHASE VARIABLES AND
 TEMPORARIES ARE ASSIGNED SLOTS ON THE STACK AND THE LENGTH OF THE BTP'S BECOMES 
 KNOWN.  NO CODE UPDATE IS DONE DURING THIS PHASE." 

<SETG PASS:2 %<RSUBR-ENTRY '[BEGIN-FRAME PASS:2 #DECL ("VALUE" ANY <LIST PFRAME>
)] 1059>> 

"THIS ROUTINE ACTUALLY DOES THE ALLOCATION OF VARIBLES.  IF IT MUST DO PREALLOCATION
 IT CALLS PRE-ALLOC-VAR." 

<SETG VAR-ALLOC %<RSUBR-ENTRY '[BEGIN-FRAME VAR-ALLOC #DECL ("VALUE" ANY PFRAME)
] 1073>> 

"THIS ROUTINE TAKES A LIST OF TEMPORARIES AND ALLOCATES THERE SPACE ON THE STACK.
 IT TRIES TO KEEP TEMPORARIES OF THE SAME TYPE TOGETHER THOUGH ITS MAIN GOAL IS
 TO MINIMIZE THE NUMBER OF TEMPORARIES.  IT RETURNS A LIST OF THE TYPES OF THE
 TEMPORARIES. A FALSE MEANS THAT THE TYPE CANNOT BE PRE-ALLOCATED." 

<SETG SLOTFIX %<RSUBR-ENTRY '[BEGIN-FRAME SLOTFIX #DECL ("VALUE" LIST LIST)] 
1142>> 

<SETG FITTMP %<RSUBR-ENTRY '[BEGIN-FRAME FITTMP #DECL ("VALUE" <OR FALSE TEMPB> 
TEMPB TEMPB)] 1352>> 

"THIS ROUTINE DOES PRE-ALLOCATION.  THE TOP FRAME GETS THE STRUCTURE AND
 THE OTHER FRAMES ARE IGNORED (THEIR TEMPS ARE ALLOCATED IN THE FIRST FRAME)." 

<SETG PRE-ALLOC-VAR1 %<RSUBR-ENTRY '[BEGIN-FRAME PRE-ALLOC-VAR1 #DECL ("VALUE" 
PFRAME PFRAME)] 1393>> 

<SETG PRE-ALLOC-VAR %<RSUBR-ENTRY '[BEGIN-FRAME PRE-ALLOC-VAR #DECL ("VALUE" 
LIST PFRAME LIST "OPTIONAL" ANY)] 1429>> 

\ 

"PASS:3 OF CUP FIXES UP THE REFERENCES TO TEMPORARIES, FIXES UP THE CODE AND
 ADDS THE PSEUDO-SETG'S." 

<SETG PASS:3 %<RSUBR-ENTRY '[BEGIN-FRAME PASS:3 #DECL ("VALUE" <PRIMTYPE LIST> 
LIST <LIST PFRAME>)] 1505>> 

<SETG FIXIT %<RSUBR-ENTRY '[BEGIN-FRAME FIXIT #DECL ("VALUE" ANY PFRAME ANY 
"OPTIONAL" ANY)] 1602>> 

<SETG ADDIT %<RSUBR-ENTRY '[BEGIN-FRAME ADDIT #DECL ("VALUE" <OR ATOM STRUCTURED
> ANY ANY FIX)] 1987>> 

\ 

<SETG PRIN-SET %<RSUBR-ENTRY '[BEGIN-FRAME PRIN-SET #DECL ("VALUE" <VECTOR [REST
STRING]>)] 2120>> 

<GDECL (TOKEN-MAX) FIX (TOKENS) <LIST [REST LIST]> (TOKEN-TABLE) <VECTOR [REST 
STRING]>> 

<SETG TOKEN-MAX 10> 

<SETG TOKENS ((,EMIT:PRE "EMIT:PRE") (,STORE:VAR "STORE:VAR") (,CREATE:TEMP 
"CREATE:TEMPORARY") (,KILL:STORE "KILL:STORE") (,STORE:TMP "STORE:TEMPORARY") (,
BEGIN:FRAME "BEGIN:FRAME") (,END:FRAME "END:FRAME") (,STORE:TVAR 
"STORE:TVARIABLE"))> 

<SETG SCL-PRINT %<RSUBR-ENTRY '[BEGIN-FRAME SCL-PRINT #DECL ("VALUE" FIX SCL)] 
2221>> 

<SETG MAP-PRINT %<RSUBR-ENTRY '[BEGIN-FRAME MAP-PRINT #DECL ("VALUE" ANY 
STRUCTURED)] 2242>> 

<SETG TOKEN-PRINT %<RSUBR-ENTRY '[BEGIN-FRAME TOKEN-PRINT #DECL ("VALUE" 
CHARACTER TOKEN)] 2298>> 

<SETG UPD %<RSUBR-ENTRY '[BEGIN-FRAME UPD #DECL ("VALUE" <PRIMTYPE LIST> <
PRIMTYPE LIST> <PRIMTYPE LIST>)] 2369>> 

<SETG LREVERSE %<RSUBR-ENTRY '[BEGIN-FRAME LREVERSE #DECL ("VALUE" LIST ANY)] 
2454>> 

\ 

"THIS ROUTINE CALLED AT ASSEMBLY TIME ALLOCATES SLOTS FOR THE TEMPORARIES." 

<SETG ALLOCATE:SLOTS %<RSUBR-ENTRY '[BEGIN-FRAME ALLOCATE:SLOTS #DECL ("VALUE" 
SPLICE <OR ATOM FIX> "OPTIONAL" FIX)] 2488>> 

<SETG FIXAD %<RSUBR-ENTRY '[BEGIN-FRAME FIXAD #DECL ("VALUE" LIST FIX)] 2638>> 

<SETG ZTMPLST %<RSUBR-ENTRY '[BEGIN-FRAME ZTMPLST #DECL ("VALUE" LIST)] 2706>> 

<SETG STORE-MTEMP %<RSUBR-ENTRY '[BEGIN-FRAME STORE-MTEMP #DECL ("VALUE" SPLICE 
ANY ANY ANY ANY)] 2719>> 

<SETG NULL-MACRO %<RSUBR-ENTRY '[BEGIN-FRAME NULL-MACRO #DECL ("VALUE" SPLICE)] 
2888>> 

<SETG DEALLOCATE %<RSUBR-ENTRY '[BEGIN-FRAME DEALLOCATE #DECL ("VALUE" SPLICE 
ANY)] 2896>> 

"FUNCTION TO EXPAND THE MACROS IN THE SOURCE GENERATED BY THE COMPILER.
 SHOULD BE CALLED AFTER CUP." 

<SETG EXP-MAC %<RSUBR-ENTRY '[BEGIN-FRAME EXP-MAC #DECL ("VALUE" LIST LIST)] 
2949>> 
