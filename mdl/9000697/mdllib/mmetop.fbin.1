'<PCODE "1MMETOP">

"(c) Copyright 1978 Massachusetts Institute of Technology.  All Rights Reserved." 

<PACKAGE "MMETOP"> 

<ENTRY RUN-DMS> 

<ENTRY EXECUTE-KEY EXPAND-COMMAND-KEY SYNC-INFW-KEY COPY-COMMAND-KEY 
COPY-LAST-COMMAND-KEY> 

<ENTRY WAIT-COMMAND EXIT-DMS FLUSH-DMS CHANGE-ROLE> 

<ENTRY QUIT-SERVICE RESTART-SERVICE> 

<ENTRY ASSIGN-ACTION NOTIFY-ACTION> 

<ENTRY RELEASE-MESSAGE CHOP-MESSAGE> 

<ENTRY ARCHIVE-MESSAGE RETRIEVE-MESSAGE> 

<ENTRY ARCHIVE-FOLDER RETRIEVE-FOLDER SHOW-ARCHIVED-FOLDERS> 

<ENTRY TELL-COMMAND> 

<ENTRY SETUP-DEMO NEXT-DEMO-COMMAND> 

<USE "MADMAN" "ASYLUM" "INVERT" "TENXIO" "MMEDEF" "MMEAUX"> 

<USE "MMEMV" "MMESYM" "MMETMV" "MMEINV" "MMESRC"> 

<USE "PVT" "SVT" "MMEVT" "MMETVT" "MMEMID" "MMEPRT"> 

<USE "MMECP"> 

<USE "MMEINT" "MMEBIN" "MMESHM" "MMEPRM" "MMECMP" "MMEFOL" "MMEFND"> 

<GDECL (DEMO-COMMAND-LIST) <OR LIST FALSE>> 

<SETG DEMO-COMMAND-LIST <>> 

"Top-Level function of entire service" 

<SETG RUN-DMS  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 0> RUN-DMS #DECL ("VALUE" ANY 
"OPTIONAL" <OR <PRIMTYPE WORD> STRING FALSE>) SMV NAME-TO-ID STJ SHOW-BIN-STATUS
 SHOW-ALERTS NCOMF SETUP-USER-VARIABLES GNB EXECUTE-KEY SCFD HANDLE-MORE-KEY 
SYNC-INFW-KEY NEXT-DEMO-COMMAND EXPAND-COMMAND-KEY SHOW-ZOOM-STATUS SHOW-ALL-KEY
 SHOW-FOLDER-STATUS ENTER-ALL-KEY SCFB "ERROR" %<RGLOC DMS-ERROR T> %<RGLOC 
DMS-ERROR-HANDLER T> "READ" %<RGLOC PROFL T> ABORT-ACT (ACTIVATION) %<RGLOC 
ACTION-LOG-NAME T> %<RGLOC ACTION-LOG-ID T> %<RGLOC INFO-LOG-NAME T> %<RGLOC 
INFO-LOG-ID T> COULDNT-START-TRUSTED-JOB!-ERRORS %<INTERNAL-RSUBR PUMAN 2> 
"<MORE>" %<RGLOC CCOMF T> %<RGLOC LCOMF T> "<SHOW-BIN-STATUS>" 
"<SHOW-ZOOM-STATUS>" "<SHOW-FOLDER-STATUS>" %<RGLOC DMS-DEBUG? T> 
USER-TYPED-CONTROL-NO-KEY!-ERRORS %<RGLOC CP-DEBUG? T> T %<RGLOC TVT-TRACE? T> 
%<RGLOC TMV-TRACE? T> "<CODE-" %<INTERNAL-RSUBR DPNUM 1> ">"]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,RUN-DMS PGLUE ![715827882 -22817013761 -256 0!
]>> 


<SETG DMS-ERROR  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 364> DMS-ERROR #DECL ("VALUE" 
ANY FRAME "TUPLE" <TUPLE [REST ANY]>) %<RGLOC DMS-DEBUG? T> ABORT-ACT]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,DMS-ERROR PGLUE ![1006632960!]>> 


<SETG SHOW-ALERTS  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 404> SHOW-ALERTS #DECL (
"VALUE" <OR ATOM FALSE> ANY ANY) CAPCHK SCFB ECOMWD SCFD %<INTERNAL-RSUBR LUMAN 
1> %<INTERNAL-RSUBR GUMAN 1> T (0) %<INTERNAL-RSUBR PUMAN 2> %<INTERNAL-RSUBR 
UUMAN 1>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,SHOW-ALERTS PGLUE ![717224960!]>> 


<SETG SETUP-USER-VARIABLES  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 530> 
SETUP-USER-VARIABLES #DECL ("VALUE" ANY) %<RGLOC VARVCT T> %<INTERNAL-RSUBR 
GUMAN 1> %<INTERNAL-RSUBR GSMAN 1> %<INTERNAL-RSUBR CDATA 1> FIX]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,SETUP-USER-VARIABLES PGLUE ![1072693248!]>> 


<GDECL (VARVCT) <VECTOR [REST <VECTOR ATOM ATOM FIX ANY>]>> 

<SETG VARVCT <VECTOR <VECTOR SMLIM FIX ,SMLOF 1> <VECTOR SHLIM FIX ,SHLOF 1> <
VECTOR SSLIM FIX ,SSLOF 5> <VECTOR SALIM FIX ,SALOF 10> <VECTOR PMLIM FIX ,PMLOF
1> <VECTOR PHLIM FIX ,PHLOF 10> <VECTOR PSLIM FIX ,PSLOF 20> <VECTOR PALIM FIX ,
PALOF 20> <VECTOR HOME-ADDRESS STRING ,HOMOF "CINCPAC HONOLULU HI">>> 

"Function Key Handlers" 

<SETG EXECUTE-KEY  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 647> EXECUTE-KEY #DECL (
"VALUE" ANY) GTC SCFD EXECUTE-SCRW MWFD COMMANDIFY SFB NCOMF %<RGLOC SCRW T> 
"<ENTER>" %<RGLOC ACOML T> %<RGLOC COMW T> %<TYPE-W WINID WORD> %<RGLOC CCOMF T>
 %<RGLOC LCOMF T> "There is no currently active command line."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,EXECUTE-KEY PGLUE ![715849727 0!]>> 


<SETG EXPAND-COMMAND-KEY  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 713> 
EXPAND-COMMAND-KEY #DECL ("VALUE" ANY) COMMANDIFY SFB NCOMF %<RGLOC ACOML T> 
"There is no currently active command line."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,EXPAND-COMMAND-KEY PGLUE ![720371712!]>> 


<SETG SHOW-ALL-KEY  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 746> SHOW-ALL-KEY #DECL (
"VALUE" ANY) COMMANDIFY SFB NCOMF %<RGLOC ACOML T> 
"There is no currently active command line."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,SHOW-ALL-KEY PGLUE ![720371712!]>> 


<SETG ENTER-ALL-KEY  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 779> ENTER-ALL-KEY #DECL (
"VALUE" ANY) COMMANDIFY SFB NCOMF %<RGLOC ACOML T> 
"There is no currently active command line."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,ENTER-ALL-KEY PGLUE ![720371712!]>> 


<SETG SYNC-INFW-KEY  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 812> SYNC-INFW-KEY #DECL (
"VALUE" ANY) GTC EINFWD MIP SB %<RGLOC COMW T> %<RGLOC INFO-PAGE-DIR T> %<RGLOC 
INFO-PAGE-DIR-LNT T> T]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,SYNC-INFW-KEY PGLUE ![717209600!]>> 


<SETG WAIT-COMMAND  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 904> WAIT-COMMAND #DECL (
"VALUE" ANY FIX) SCF SCFD %<RGLOC PRTSP T> %<TYPE-W SPACE VECTOR> 
%<INTERNAL-RSUBR ARESET 3> "Waiting for " %<INTERNAL-RSUBR DPNUM 1> " seconds." 
%<INTERNAL-RSUBR ASTRING 262143> "Finished waiting."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,WAIT-COMMAND PGLUE ![738196480!]>> 


<SETG EXIT-DMS  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 950> EXIT-DMS #DECL ("VALUE" 
FALSE) CHECK-COMPOSITION-WINDOW SCF FLUSH-DMS STOP-SVT "Good-bye." T %<RGLOC 
DATACHAN T>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,EXIT-DMS PGLUE ![717160448!]>> 


<SETG FLUSH-DMS  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 986> FLUSH-DMS #DECL ("VALUE" 
ANY <OR ATOM FALSE>) FLUSH-SEARCH-TREE FFSTB FLSMV %<INTERNAL-RSUBR PUMAN 2> %<
RGLOC RLDAT T> %<RGLOC CURRENT-COMPOS-MESSAGE-ID T> %<RGLOC CURRENT-FORMAT-ID T>
 %<RGLOC CURRENT-FORMAT T> %<RGLOC UNFINISHED-VECTOR T>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,FLUSH-DMS PGLUE ![721416192!]>> 


<SETG CHANGE-ROLE  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 1071> CHANGE-ROLE #DECL (
"VALUE" ANY <VECTOR FIX MSGID FIX FIX ANY <OR STRING FALSE>>) CAPCHK SCFB 
CHECK-PENDING-SCRATCH FLUSH-DMS SMV SETUP-USER-VARIABLES SCFD SHOW-ALERTS FLSMV 
%<RGLOC USDAT T> %<RGLOC RLDAT T> T %<INTERNAL-RSUBR CDATA 1> %<RGLOC RUSDAT T> 
%<RGLOC PRTSP T> %<TYPE-W SPACE VECTOR> %<INTERNAL-RSUBR ARESET 3> 
"You are already logged in as '" "'; command aborted." %<INTERNAL-RSUBR ASTRING 
262143> "You are already acting as '" %<RGLOC USLLV T> USCLV %<INTERNAL-RSUBR 
PUMAN 2> %<RGLOC STATE-LINE T> "User '" "' is no longer assuming any role." 
%<INTERNAL-RSUBR GUMAN 1> "' has assumed the role of '" "'." 
"You are not authorized to activate '" "Role not activated."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,CHANGE-ROLE PGLUE ![715829247 -4 0!]>> 


"Action Assignment Functions" 

<SETG ASSIGN-ACTION  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 1540> ASSIGN-ACTION #DECL 
("VALUE" ANY ANY <OR <VECTOR FIX MSGID FIX FIX ANY <OR STRING FALSE>> FALSE>) 
CAPCHK COM-HARDSET SCFB MAP-SET T %<TYPE-C INV VECTOR> %<INTERNAL-RSUBR 
INV-LENGTH 1> %<INTERNAL-RSUBR CDATA 1> %<RGLOC USDAT T> 
"You cannot assign action to yourself; command aborted." %<RGLOC PRTSP T> %<
TYPE-W SPACE VECTOR> %<INTERNAL-RSUBR ARESET 3> "The user/role called " 
" may not accept action assignments; command aborted." %<INTERNAL-RSUBR ASTRING 
262143> "Invalid local addressee specified; action assignment aborted." %<RGLOC 
ASS-MSG1 T>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,ASSIGN-ACTION PGLUE ![717225983 -1073741824!]>
> 


<SETG ASS-MSG1  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 1678> ASS-MSG1 #DECL ("VALUE" 
ANY MSGID FIX STRING SPACE) GME SCFB CAPCHK THIS-USER AME INVERT-MESSAGE-FIELD 
DSM SM MODIFY-INVERSIONS %<TYPE-W SPACE VECTOR> %<INTERNAL-RSUBR ARESET 3> %<
TYPE-W MSGID WORD> %<RGLOC USDAT T> T %<INTERNAL-RSUBR ALIST 262143> "Message #"
 %<INTERNAL-RSUBR DPNUM 1> " has previously been assigned to user " 
"; command aborted." %<INTERNAL-RSUBR ASTRING 262143> %<INTERNAL-RSUBR ACONS 3> 
"You are not authorized to originate action messages; message #" 
" not assigned." %<RGLOC ACTION-LOG-ID T> %<RGLOC VCT2 T> %<RGLOC ASSACTADD T> 
%<RGLOC ASSACTDEL T> %<RGLOC FILEADD T> %<RGLOC FILEDEL T>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,ASS-MSG1 PGLUE ![715829247 -256 0!]>> 


<SETG NOTIFY-ACTION  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 2080> NOTIFY-ACTION #DECL 
("VALUE" ANY ANY) CAPCHK COM-HARDSET MAP-SET T %<TYPE-C INV VECTOR> %<RGLOC 
ACT-MSG1 T> %<RGLOC PRTSP T> %<TYPE-W SPACE VECTOR>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,NOTIFY-ACTION PGLUE ![721403904!]>> 


<SETG ACT-MSG1  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 2129> ACT-MSG1 #DECL ("VALUE" 
ANY MSGID SPACE) GME DSM AME THIS-USER INVERT-MESSAGE-FIELD SM MODIFY-INVERSIONS
 SCFB %<TYPE-W SPACE VECTOR> %<INTERNAL-RSUBR ARESET 3> %<TYPE-W MSGID WORD> %<
RGLOC USDAT T> T %<INTERNAL-RSUBR ACONS 3> %<INTERNAL-RSUBR ALIST 262143> %<
RGLOC ACTION-LOG-ID T> %<RGLOC VCT2 T> %<INTERNAL-RSUBR GET-DATE 0> %<RGLOC 
ACTCOMPADD T> %<RGLOC ACTCOMPDEL T> 
"You have not been assigned action on message #" %<INTERNAL-RSUBR DPNUM 1> 
" and thus may not declare its completion." %<INTERNAL-RSUBR ASTRING 262143>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,ACT-MSG1 PGLUE ![715833343 -262144!]>> 


<SETG RELEASE-MESSAGE  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 2427> RELEASE-MESSAGE #
DECL ("VALUE" ANY ANY) CAPCHK SCFB COM-HARDSET MAP-SET 
"You have do not have the authority to release messages; command aborted." %<
RGLOC TRDAT T> 
"Messages may not be released from this terminal; command aborted." %<TYPE-C INV
VECTOR> %<RGLOC REL-MSG1 T> %<RGLOC PRTSP T> %<TYPE-W SPACE VECTOR>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,RELEASE-MESSAGE PGLUE ![717225728!]>> 


<SETG REL-MSG1  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 2495> REL-MSG1 #DECL ("VALUE" 
ANY MSGID SPACE) KOSHER? GME SCFB CONFIRM THIS-USER AME INVERT-MESSAGE-FIELD FMF
 SM DSM MODIFY-INVERSIONS %<TYPE-W MSGID WORD> T %<TYPE-W SPACE VECTOR> 
%<INTERNAL-RSUBR ARESET 3> %<RGLOC VCT2 T> %<INTERNAL-RSUBR UMSGE 4> 
" has not chopped message #" %<INTERNAL-RSUBR DPNUM 1> 
"; please confirm the release." %<INTERNAL-RSUBR ASTRING 262143> 
%<INTERNAL-RSUBR GET-DATE 0> %<INTERNAL-RSUBR ATQUE 3> %<RGLOC INFO-LOG-ID T> %<
RGLOC USDAT T> %<RGLOC RELEASEDADD T> %<RGLOC RELEASEDDEL T> "Message #" 
" has been released."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,REL-MSG1 PGLUE ![715827967 -256 0!]>> 


<SETG ASSIGN-DTG  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 2869> ASSIGN-DTG #DECL (
"VALUE" FIX) %<INTERNAL-RSUBR GET-DATE 0>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,ASSIGN-DTG PGLUE ![805306368!]>> 


<SETG CHOP-MESSAGE  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 2901> CHOP-MESSAGE #DECL (
"VALUE" <OR ATOM FALSE> ANY) CAPCHK COM-HARDSET MAP-SET SCFD T %<TYPE-C INV 
VECTOR> %<RGLOC CHOP-MSG1 T> "Message(s) chopped."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,CHOP-MESSAGE PGLUE ![717209600!]>> 


<SETG CHOP-MSG1  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 2951> CHOP-MSG1 #DECL ("VALUE"
ANY MSGID) THIS-USER AME INVERT-MESSAGE-FIELD SM %<TYPE-W MSGID WORD>]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,CHOP-MSG1 PGLUE ![716177408!]>> 


"Archiving Functions" 

<SETG ARCHIVE-MESSAGE  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 2986> ARCHIVE-MESSAGE #
DECL ("VALUE" ATOM "TUPLE" ANY) SCFB 
"The Archive Message command is not operative in this environment." T]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,ARCHIVE-MESSAGE PGLUE ![788529152!]>> 


<SETG RETRIEVE-MESSAGE  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 3019> RETRIEVE-MESSAGE 
#DECL ("VALUE" ATOM "TUPLE" ANY) SCFB 
"The Retrieve Message command is not operative in this environment." T]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,RETRIEVE-MESSAGE PGLUE ![788529152!]>> 


<SETG ARCHIVE-FOLDER  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 3052> ARCHIVE-FOLDER #
DECL ("VALUE" ATOM "TUPLE" ANY) SCFB 
"The Archive Folder command is not operative in this environment." T]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,ARCHIVE-FOLDER PGLUE ![788529152!]>> 


<SETG RETRIEVE-FOLDER  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 3085> RETRIEVE-FOLDER #
DECL ("VALUE" ATOM "TUPLE" ANY) SCFB 
"The Retrieve Folder command is not operative in this environment." T]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,RETRIEVE-FOLDER PGLUE ![788529152!]>> 


<SETG SHOW-ARCHIVED-FOLDERS  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 3118> 
SHOW-ARCHIVED-FOLDERS #DECL ("VALUE" ATOM "TUPLE" ANY) SCFB 
"The Show Archived Folders command is not operative in this environment." T]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,SHOW-ARCHIVED-FOLDERS PGLUE ![788529152!]>> 


<SETG TELL-COMMAND  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 3151> TELL-COMMAND #DECL (
"VALUE" ANY "OPTIONAL" <OR <VECTOR FIX MSGID FIX FIX ANY <OR STRING FALSE>> 
FALSE> <OR <VECTOR FIX MSGID FIX FIX ANY <OR STRING FALSE>> FALSE>) CAPCHK SCFB 
DSM SCF CHECK-PENDING-SCRATCH RSM AME LOAD-INTO-WINDOW SET-PENDING-SCRATCH T %<
RGLOC USDAT T> "It doesn't make sense to send an alert to yourself." %<RGLOC 
PRTSP T> %<TYPE-W SPACE VECTOR> %<INTERNAL-RSUBR ARESET 3> %<INTERNAL-RSUBR 
ALIST 262143> "Alert sent." %<TYPE-W MSGID WORD> %<RGLOC VCT2 T> %<RGLOC SCRW T>
 %<TYPE-W WINID WORD> %<RGLOC TELL-COMMAND-TEMPLATE T> %<RGLOC 
TELL-COMMAND-FOLLOWUP T> 
"About to abort the previous TELL command; please confirm."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,TELL-COMMAND PGLUE ![715829247 -262144!]>> 


<SETG TELL-COMMAND-FOLLOWUP  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 3345> 
TELL-COMMAND-FOLLOWUP #DECL ("VALUE" ANY LIST) RSM DUMP-FROM-WINDOW 
GET-LOCAL-ADDRESSEES GME DSM SCFD CLEAR-PENDING-SCRATCH %<RGLOC SCRW T> %<TYPE-W
WINID WORD> %<TYPE-W MSGID WORD> %<RGLOC ACTION-ASSIGNMENT-FIELDS T> 
"Alert sent." "No text entered; alert not sent." 
"No legal users entered; alert not sent."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,TELL-COMMAND-FOLLOWUP PGLUE ![715849724 0!]>> 


<SETG SETUP-DEMO  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 3425> SETUP-DEMO #DECL (
"VALUE" ANY ANY) SCFD SCFB %<INTERNAL-RSUBR CDATA 1> %<RGLOC DEMO-COMMAND-LIST T
> "Canned demo command list started." 
"Can't get command list associated with that name."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,SETUP-DEMO PGLUE ![737935360!]>> 


<SETG NEXT-DEMO-COMMAND  %<RSUBR!- '[ %<PCODE!- "1MMETOP" 3459> 
NEXT-DEMO-COMMAND #DECL ("VALUE" ANY) AWED SCFD SCFB %<RGLOC DEMO-COMMAND-LIST T
> %<RGLOC ACOML T> %<RGLOC COMW T> %<TYPE-W WINID WORD> T 
"The following is the last command in this canned command list." 
"There is no currently active canned command list; use the 'Demo' command."]>> 
<AND <ASSIGNED? GLUE> .GLUE <PUT ,NEXT-DEMO-COMMAND PGLUE ![721419264!]>> 


<ENDPACKAGE> 
