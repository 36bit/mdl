<PACKAGE "GNJFN">

<ENTRY NEXT-FILE GNJFN-RESET GET-TABLE DO-SYSGT DO-GETAB CUR-STATE
       DO-RFTAD DO-GFUST DO-ODTIM>

<USE "NSTR">

<SETG LAST-SPEC "">

<SETG FILE-SCRATCH <ISTRING 100>>

<GDECL (LAST-SPEC) STRING (FILE-SCRATCH) STRING>

"On 20x, the state is simply a JFN (full-word), which can be passed
to GNJFN.  If it is false, we aren't initialized.  On ITS, the state is
a pair:  a pointer into a uvector of directories to be searched, and
a pointer into the current directory."

<SETG CUR-STATE <>>

"Takes a file spec, including *'s, and returns a vector containing
a string and bits as for the GNJFN call, or false if no more files."
<DEFINE NEXT-FILE ("OPTIONAL" (SPEC ,LAST-SPEC) (V <>) "AUX" RES CS)
  #DECL ((SPEC) STRING (CS RES) <OR FALSE <PRIMTYPE WORD>>
	 (V) <OR FALSE <VECTOR ANY>>)
  <COND (<N=? .SPEC ,LAST-SPEC>
	 <GNJFN-RESET>)>
  <SETG LAST-SPEC .SPEC>
  <SET CS ,CUR-STATE>
  <COND (<NOT .CS>
	 <COND (<SETG CUR-STATE <SET RES <DO-GTJFN .SPEC>>>
		<MAKE-RES .RES #WORD 7 .V>)
	       (<>)>)
	(T
	 <COND (<SET RES <DO-GNJFN .CS>>
		<MAKE-RES .RES <LSH .RES -19> .V>)
	       (<SETG CUR-STATE <>>)>)>>

<DEFINE MAKE-RES (CS B V)
  #DECL ((B) WORD (V) <OR <VECTOR ANY> FALSE>)
  <COND (<NOT .V>
	 <SET V <IVECTOR 2>>)>
  <PUT .V 1 <FILE-STRING .CS>>
  <COND (<G? <LENGTH .V> 1>
	 <PUT .V 2 .B>
	 <COND (<G? <LENGTH .V> 2>
		<PUT .V 3 <DO-SIZEF .CS>>
		<COND (<G? <LENGTH .V> 3>
		       <PUT .V 4 <BYTSIZE .CS>>)>)>)>
  .V>

<DEFINE GNJFN-RESET ("OPTIONAL" (FLUSH? <>))
  #DECL ((FLUSH?) <OR ATOM FALSE>)
  <COND (,CUR-STATE
	 <DO-RLJFN ,CUR-STATE>
	 <SETG CUR-STATE <>>)>>

<DEFINE FILE-STRING (CS)
  <DO-JFNS .CS>>

<DEFINE GET-TABLE (NAME "AUX" UV IDX TV (N 0))
  #DECL ((NAME) <OR STRING <PRIMTYPE WORD>> (IDX N) FIX
	 (TV) WORD (UV) <UVECTOR [REST WORD]>)
  <COND (<NOT <0? <CHTYPE <SET TV <DO-SYSGT .NAME>> FIX>>>
	 <SET UV <IUVECTOR <- <CHTYPE <ORB *777777000000*
					   <GETBITS .TV <BITS 18 18>>>
				      FIX>>
			   #WORD 0>>
	 <SET IDX <CHTYPE <GETBITS .TV <BITS 18 0>> FIX>>
	 <MAPR <>
	   <FUNCTION (UV) #DECL ((UV) <UVECTOR [REST WORD]>)
	     <PUT .UV 1 <DO-GETAB .IDX .N>>
	     <SET N <+ .N 1>>>
	   .UV>
	 .UV)>>


<TITLE DO-RFTAD>
	<DECLARE ("VALUE" <UVECTOR [REST WORD]> CHANNEL
		  "OPTIONAL" <UVECTOR [REST WORD]>)>
	<MOVE	A* AB>
PLOOP	<DPUSH	TP* (AB)>
	<ADD	AB* [<(2) 2>]>
	<JUMPL	AB* PLOOP>
	<HLRES	A>
	<ASH	A* -1>
	<ADDI	A* DTAB>
	<PUSHJ	P* @ 1(A)>
	<JRST	FINIS>
	<IRFTA2>
DTAB	<IRFTA1>

<INTERNAL-ENTRY IRFTA1 1>
	<SUBM	M* (P)>
	<MOVEI	A* 4>
	<MOVEI	O* IBLOCK>
	<PUSHJ	P* RCALL>
	<DPUSH	TP* A>
	<ADDI	B* 4>
	<MOVEI	O* <TYPE-CODE WORD>>
	<PUTYP	O* (B)>
	<CAIA>
<INTERNAL-ENTRY IRFTA2 2>
	 <SUBM	M* (P)>
	<MOVE	A* -2(TP)>
	<MOVE	A* 1(A)>
	<HRRZ	B* (TP)>
	<HLRE	C* (TP)>
	<MOVNS	C>
	<RFTAD>
	<POP	TP* B>
	<POP	TP* A>
	<SUB	TP* [<(2) 2>]>
	<JRST	MPOPJ>

<END>

<TITLE DO-GFUST>
	<DECLARE ("VALUE" STRING CHANNEL FIX "OPTIONAL" STRING)>
	<HLRE	A* AB>
PLOOP	<DPUSH	TP* (AB)>
	<ADD	AB* [<(2) 2>]>
	<JUMPL	AB* PLOOP>
	<ASH	A* -1>
	<ADDI	A* DTAB>
	<PUSHJ	P* @ 2(A)>
	<JRST	FINIS>
	<IGFUS3>
DTAB	<IGFUS2>

<INTERNAL-ENTRY IGFUS2 2>
	<SUBM	M* (P)>
	<MOVEI	A* 6>
	<MOVEI	O* IBLOCK>
	<PUSHJ	P* RCALL>
	<PUSH	TP* [<(<TYPE-CODE STRING>) 30>]>
	<HRLI	B* *10700*>
	<SUBI	B* 1>
	<PUSH	TP* B>
	<CAIA>
<INTERNAL-ENTRY IGFUS3 3>
	 <SUBM	M* (P)>
	<MOVE	B* (TP)>
	<MOVE	A* -4(TP)>
	<MOVE	A* 1(A)>
	<HRL	A* -2(TP)>
	<GFUST>
	<LDB	O* [<(*360600*) B>]>
	<IDIVI	O* 7>
ENDSL	<TLZ	B* -1>
	<HRRZ	C* (TP)>
	<SUBM	B* C>
	<IMULI	C* 5>
	<SUB	C* O>			; "LENGTH OF STRING"
	<HRRZ	A* -1(TP)>
	<SUB	A* C>
	<IDIVI	A* 5>
	<MOVE	D* (TP)>
	<ADD	D* A>
	<JUMPE	B* ENDI>
BEGI	<IBP	D>
	<SOJG	B* BEGI>
; "D HAS DESTINATION BPT FOR SUBSTRUC, C HAS DESTINATION LENGTH"
; "SOURCE STRING IS (TP)"
ENDI	<PUSH	TP* <TYPE-WORD FIX>>
	<PUSH	TP* [0]>
	<PUSH	TP* <TYPE-WORD FIX>>
	<PUSH	TP* C>
	<HRLI	C* <TYPE-CODE STRING>>
	<PUSH	TP* C>
	<PUSH	TP* D>
	<MOVEI	A* 4>
	<PUSHJ	P* CSBSTR>
	<SUB	TP* [<(4) 4>]>
	<JRST	MPOPJ>
<END>

<TITLE DO-ODTIM>
<DECLARE ("VALUE" ANY <PRIMTYPE WORD> <OR CHANNEL STRING>
	  "OPTIONAL" <PRIMTYPE WORD>)>
	<HLRE	A* AB>
PLOOP	<DPUSH	TP* (AB)>
	<ADD	AB* [<(2) 2>]>
	<JUMPL	AB* PLOOP>
	<ASH	A* -1>
	<ADDI	A* DTAB>
	<PUSHJ	P* @ 2(A)>
	<JRST	FINIS>
	<IODTI3>
DTAB	<IODTI2>

<INTERNAL-ENTRY IODTI2 2>
	<PUSH	TP* <TYPE-WORD FIX>>
	<PUSH	TP* [0]>
<INTERNAL-ENTRY IODTI3 3>
	<SUBM	M* (P)>
	<MOVE	A* -2(TP)>
	<GETYP	O* -3(TP)>
	<CAIE	O* <TYPE-CODE STRING>>
	 <MOVE	A* 1(A)>
	<MOVE	B* -4(TP)>
	<MOVE	C* (TP)>
	<ODTIM>
	<ADJSP	TP* -6>
	<JRST	MPOPJ>
<END>


<TITLE DO-RLJFN>
	<DECLARE ("VALUE" <PRIMTYPE WORD> <PRIMTYPE WORD>)>
	<DPUSH	TP* (AB)>
	<PUSHJ	P* IRLJFN>
	<JRST	FINIS>

<INTERNAL-ENTRY IRLJFN 1>
	<SUBM	M* (P)>
	<MOVE	A* (TP)>
	<RLJFN>
	 <JFCL>
	<POP	TP* B>
	<POP	TP* A>
	<JRST	MPOPJ>

<TITLE DO-GTJFN>
	<DECLARE ("VALUE" <OR FALSE WORD> STRING)>
	<DPUSH	TP* (AB)>
	<PUSHJ	P* IGTJFN>
	<JRST	FINIS>

<INTERNAL-ENTRY IGTJFN 1>
	<SUBM	M* (P)>
	<PUSH	TP* <TYPE-WORD CHARACTER>>
	<PUSH	TP* [0]>
	<MOVEI	A* 2>
	<PUSHJ	P* CISTNG>	; "MAKE SURE IT ENDS IN 0"
	<MOVSI	A* *100121*>	; "GJ%OLD+GJ%IFG+GJ%FLG+GJ%SHT"
	<GTJFN>
	 <JRST	GTRF>
	<MOVE	B* A>
	<MOVSI	A* <TYPE-CODE WORD>>
	<JRST	MPOPJ>
GTRF	<MOVSI	A* <TYPE-CODE FALSE>>
	<MOVEI	B* 0>
	<JRST	MPOPJ>

<TITLE	DO-GNJFN>
	<DECLARE ("VALUE" <OR WORD FALSE> <PRIMTYPE WORD>)>
	<DPUSH	TP* (AB)>
	<PUSHJ	P* IGNJFN>
	<JRST	FINIS>

<INTERNAL-ENTRY IGNJFN 1>
	<SUBM	M* (P)>
	<MOVE	A* (TP)>
	<GNJFN>
	 <JRST	GNRF>
	<MOVE	B* A>
	<MOVSI	A* <TYPE-CODE WORD>>
GNOUT	<SUB	TP* [<(2) 2>]>
	<JRST	MPOPJ>
GNRF	<MOVSI	A* <TYPE-CODE FALSE>>
	<MOVEI	B* 0>
	<JRST	GNOUT>

<TITLE DO-JFNS>
	<DECLARE ("VALUE" STRING <PRIMTYPE WORD>)>
	<DPUSH	TP* (AB)>
	<PUSHJ	P* IJFNS>
	<JRST	FINIS>

<INTERNAL-ENTRY IJFNS 1>
	<SUBM	M* (P)>
	<MOVE	A* <MQUOTE <RGLOC FILE-SCRATCH T>>>
	<ADD	A* GLOTOP 1>
	<PUSH	TP* (A)>
	<PUSH	TP* 1(A)>
	<MOVE	A* 1(A)>
	<HRRZ	B* -2(TP)>
	<MOVE	C* [<(*111110*) *000001*>]>
	<MOVEI	D* 0>
	<JFNS>
	<HRRZ	B* A>
	<HRRZ	C* (TP)>
	<SUB	B* C>
	<IMULI	B* 5>
JFNLOP	<TLNN	A* *760000*>
	 <JRST	JFNDON>
	<IBP	A>
	<SOJA	B* JFNLOP>
JFNDON	<PUSH	TP* <TYPE-WORD FIX>>
	<PUSH	TP* [0]>
	<PUSH	TP* <TYPE-WORD FIX>>
	<PUSH	TP* B>
	<MOVEI	A* 3>
	<PUSHJ	P* CSBSTR>
	<SUB	TP* [<(2) 2>]>
	<JRST	MPOPJ>

<TITLE DO-SIZEF>
	<DECLARE ("VALUE" FIX WORD)>
	<DPUSH	TP* (AB)>
	<PUSHJ	P* ISIZEF>
	<JRST	FINIS>

<INTERNAL-ENTRY ISIZEF 1>
	<SUBM	M* (P)>
	<HRRZ	A* (TP)>
	<SIZEF>
	 <JFCL>
	<MOVSI	A* <TYPE-CODE FIX>>
	<SUB	TP* [<(2) 2>]>
	<JRST	MPOPJ>

<TITLE BYTSIZE>
	<DECLARE ("VALUE" FIX WORD)>
	<DPUSH	TP* (AB)>
	<PUSHJ	P* IB>
	<JRST	FINIS>

<INTERNAL-ENTRY IB 1>
	<SUBM	M* (P)>
	<HRRZ	A* (TP)>
	<MOVE	B* [<(1) *11*>]>
	<MOVEI	C* D>
	<GTFDB>
	<LDB	B* [<(*300600*) D>]>
	<SKIPN	B>
	 <MOVEI	B* 36>
	<MOVSI	A* <TYPE-CODE FIX>>
	<SUB	TP* [<(2) 2>]>
	<JRST	MPOPJ>

<END>


<TITLE DO-GETAB>
	<DECLARE ("VALUE" <OR FALSE WORD> <PRIMTYPE WORD> FIX)>
	; "FIRST ARG IS TABLE #, SECOND IS OFFSET"
	<DPUSH	TP* (AB)>
	<DPUSH	TP* 2(AB)>
	<PUSHJ	P* IGETAB>
	<JRST	FINIS>

<INTERNAL-ENTRY IGETAB 2>
	<SUBM	M* (P)>
	<HRL	A* (TP)>
	<HRR	A* -2(TP)>
	<GETAB>
	 <JRST	IGETFL>
	<MOVE	B* A>
	<MOVSI	A* <TYPE-CODE WORD>>
IGETOT	<SUB	TP* [<(4) 4>]>
	<JRST	MPOPJ>
IGETFL	<MOVE	D* A>
	<MOVSI	C* <TYPE-CODE WORD>>
	<MOVEI	E* 0>
	<PUSHJ	P* CICONS>
	<MOVSI	A* <TYPE-CODE FALSE>>
	<JRST	IGETOT>
<END>

<TITLE DO-SYSGT>
	<DECLARE ("VALUE" WORD <OR STRING <PRIMTYPE WORD>>
		  "OPTIONAL" <OR ATOM FALSE>)>
	;"FIRST ARG IS TABLE NAME, SECOND (DEFAULT FALSE) SAYS TO RETURN
	  WORD 0 INSTEAD OF -LEN,,NUMBER"
	<MOVE	A* AB>
PLOOP	<DPUSH	TP* (AB)>
	<ADD	AB* [<(2) 2>]>
	<JUMPL	AB* PLOOP>
	<HLRES	A>
	<ASH	A* -1>
	<ADDI	A* DTAB>
	<PUSHJ	P* @ 1(A)>
	<JRST	FINIS>
	<ISYS2>
DTAB	<ISYS1>

<INTERNAL-ENTRY ISYS1 1>
	<PUSH	TP* <TYPE-WORD FALSE>>
	<PUSH	TP* [0]>
<INTERNAL-ENTRY ISYS2 2>
	<SUBM	M* (P)>
	<GETYP	A* -3(TP)>
	<CAIE	A* <TYPE-CODE STRING>>
	 <JRST	DOIT>
	<PUSH	TP* -3(TP)>
	<PUSH	TP* -3(TP)>
	<MCALL	1 STRTOX>
	<MOVEM	A* -3(TP)>
	<MOVEM	B* -2(TP)>
DOIT	<MOVE	A* -2(TP)>
	<SYSGT>
	<SKIPGE	(TP)>
	 <MOVE	B* A>
	<MOVSI	A* <TYPE-CODE WORD>>
	<SUB	TP* [<(4) 4>]>
	<JRST	MPOPJ>
<END>

<ENDPACKAGE>