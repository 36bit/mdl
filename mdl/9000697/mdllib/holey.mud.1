<PACKAGE "HOLEY">

<ENTRY COPY-HOLEY-FILE>

<ENTRY GET-PAGE-MAP>


<USE "TENXIO">


<DEFINE GET-PAGE-MAP (FIL "AUX" MAPVCT FILJFN VAL FIRSTUV NEXTUV PG)
#DECL ((FIL) <OR JFN STRING>
	(FILJFN) <OR JFN FALSE>
	(FIRSTUV NEXTUV) <OR <UVECTOR [2 FIX]> FALSE>
	(PG) FIX
	(VAL) ANY
	(VALUE MAPVCT) <OR <VECTOR [REST <UVECTOR [2 FIX]>]> FALSE>)
<COND	(<COND	(<TYPE? .FIL JFN> <SET FILJFN .FIL>)
		(<SET FILJFN <GET-FILE .FIL *100000000000*>>
		<COND	(<SET VAL <OPEN-FILE .FILJFN *440000200000*>>)
			(<RELEASE-FILE .FILJFN>
			.VAL)>)>
	<COND	(<SET VAL <FIND-FIRST-FREE-FILE-PAGE .FILJFN>>
		<COND	(<G? .VAL 0>
			<SET FIRSTUV <UVECTOR 0 .VAL>>)
			(<SET FIRSTUV <SET NEXTUV <>>>)>
		<SET MAPVCT <MAPF ,VECTOR <FUNCTION ()
				<COND	(.FIRSTUV
					<COND	(<SET VAL <FIND-FIRST-USED-FILE-PAGE
								.FILJFN <2 .FIRSTUV>>>
						<SET NEXTUV <UVECTOR .VAL 1>>
						<SET VAL .FIRSTUV>
						<SET FIRSTUV <>>
						<MAPRET .VAL>)
						(<MAPSTOP .FIRSTUV>)>)
					(<AND	.NEXTUV
						<SET VAL <FIND-FIRST-USED-FILE-PAGE
							.FILJFN
							<SET PG <+ <1 .NEXTUV>
								<2 .NEXTUV>>>>>>
					<COND	(<==? .VAL .PG>
						<PUT .NEXTUV 2 <+ 1 <2 .NEXTUV>>>
						<MAPRET>)
						(<SET FIRSTUV .NEXTUV>
						<SET NEXTUV <UVECTOR .VAL 1>>
						<SET VAL .FIRSTUV>
						<SET FIRSTUV <>>
						<MAPRET .VAL>)>)
					(.NEXTUV
					<MAPSTOP .NEXTUV>)
					(<SET VAL <FIND-FIRST-USED-FILE-PAGE .FILJFN 0>>
					<SET NEXTUV <UVECTOR .VAL 1>>
					<MAPRET>)
					(<MAPSTOP>)>>>>)
			(<SET MAPVCT <>>)>
	<COND	(<TYPE? .FIL STRING>
		<CLOSE-FILE .FILJFN 0>)>
	.MAPVCT)>>


<DEFINE COPY-HOLEY-FILE (INFIL OUTFIL "AUX" INJFN OUTJFN VAL PG MPG CPG)
#DECL ((INFIL OUTFIL) <OR JFN STRING>
	(INJFN OUTJFN) <OR JFN FALSE>
	(PG) <OR FIX FALSE>
	(CPG MPG) FIX
	(VAL) ANY)
<COND	(<AND	<COND	(<TYPE? .INFIL JFN> <SET INJFN .INFIL>)
			(<SET INJFN <GET-FILE .INFIL *100000000000*>>
			<COND	(<SET VAL <OPEN-FILE .INJFN *440000200000*>>)
				(<RELEASE-FILE .INJFN>
				.VAL)>)>
		<COND	(<TYPE? .OUTFIL JFN> <SET OUTJFN .OUTFIL>)
			(<SET OUTJFN <GET-FILE .OUTFIL *400000000000*>>
			<COND	(<SET VAL <OPEN-FILE .OUTJFN *440000300000*>>)
				(<RELEASE-FILE .OUTJFN>
				<AND	<TYPE? .INFIL STRING>
					<CLOSE-FILE .INJFN 0>>
				.VAL)>)>>
	<SET PG 0>
	<SET MPG <PAGE-FIND 1>>
	<SET CPG <* .MPG 2>>
	<MAPF <> <FUNCTION ()
			<COND	(<SET PG <FIND-FIRST-USED-FILE-PAGE .INJFN .PG>>
				<OR	<SET VAL <PMAP-FILE .INJFN .PG *400000* .CPG
								*100400000000*>>
					<ERROR PMAP-ERROR!-ERRORS .INJFN .PG .CPG .VAL>>
				<TOUCH-PAGE <* .MPG 1024>>
				<OR	<SET VAL <PMAP-FILE *400000* .CPG .OUTJFN .PG
								*140000000000*>>
					<ERROR PMAP-ERROR!-ERRORS .OUTJFN
							.PG .CPG .VAL>>
				<SET PG <+ 1 .PG>>)
				(<MAPLEAVE>)>>>
	<PMAP-FILE -1 -1 *400000* .CPG 0>
	<COND	(<TYPE? .INFIL STRING>
		<CLOSE-FILE .INJFN 0>)>
	<COND	(<TYPE? .OUTFIL STRING>
		<CLOSE-FILE .OUTJFN 0>)>
	T)>>




<SETG TOUCH-PAGE %<FIXUP!-RSUBRS!- '[#CODE ![23851171840 23851171841 23751557124
23085678677 25614352384 17191141376 17196908544 17465344000 23983030274 
23983030273 23085698016 262148 7432972842 0 262146!] TOUCH-PAGE #DECL ("VALUE" 
FIX FIX)] '(53 FINIS!-MUDDLE 229461 (4) MPOPJ!-MUDDLE 248800 (11))>> 

<AND <ASSIGNED? GLUE> .GLUE <PUT ,TOUCH-PAGE GLUE '![1073741824 262148!]>>

<ENDPACKAGE>
